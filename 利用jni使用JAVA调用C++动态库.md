# 利用jni使用JAVA调用C++动态库



## 1. JAVA创建native方法的类

```java
public class JNIEntry {
    public native int useCppSum(int a, int b);
}
```

注意没有函数体。



## 2. 生成头文件命令

- java 8
  - javah -jni -o JNIEntry.h JNIEntry
- java 11
  - javac -h jni JNIEntry.java

生成头文件。



## 3. C++动态库生成

- 引入jni生成的头文件，并在JAVA安装目录下找到jni.h和jni_md.h，拷贝到工程目录下include。

```c++
/* DO NOT EDIT THIS FILE - it is machine generated */
#include "jni.h"
#include "jni_md.h"
/* Header for class JNIEntry */

#ifndef _Included_JNIEntry
#define _Included_JNIEntry
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     JNIEntry
 * Method:    useCppSum
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_JNIEntry_useCppSum
  (JNIEnv *, jobject, jint a, jint b);

#ifdef __cplusplus
}
#endif
#endif
```

- 实现头文件中的函数体。

```c++
#include "JNIEntry.h"
#include "library.h"

JNIEXPORT jint JNICALL Java_JNIEntry_useCppSum(JNIEnv *, jobject, jint a, jint b) {
    return sum(a, b);
}
```

- 使用CMake生成动态链接库。

```cmake
cmake_minimum_required(VERSION 3.17)
project(libtest)

set(CMAKE_CXX_STANDARD 20)

add_library(test SHARED library.cpp JNIEntry.h)
target_link_libraries(test /home/peterchen/CLionProjects/libtest/libSumAB.so)
```

动态库也可以链接第三方动态库，直接参照CMake即可。

```cmake
cmake_minimum_required(VERSION 3.17)
project(libSumAB)

set(CMAKE_CXX_STANDARD 20)

include_directories("/home/peterchen/intel/oneapi/ipp/latest/include")
link_directories("/home/peterchen/intel/oneapi/ipp/latest/lib/intel64")

add_library(SumAB SHARED library.cpp library.h)
target_link_libraries(SumAB ippcore ipps)
```



## 4. JAVA调用动态链接库

- `System.load()`方法使用绝对路径，`System.loadLibrary()`使用动态链接库名称，但需要配置环境变量。

```java
public class testUseCppSum {
    public static void main(String[] args) {
        System.load("/home/peterchen/IdeaProjects/testJNI/src/libtest.so");
        new JNIEntry().useCppSum(5, 6);
    }
}
```



## 5. JAVA打jar包

直接用maven创建项目管理package即可



## 6. Scala运行jar包

scala -classpath testJNI.jar testCppSum